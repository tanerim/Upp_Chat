<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upp Chat</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <!-- Header -->
  <header>
    <h1>Upp Chat</h1>
    <p>Local LLM Conversation Environment</p>
  </header>

  <!-- Settings Section -->
  <section class="settings">
    <div class="model-card">
      <h3>Left Model</h3>
      <div class="inline-field">
        <label for="leftModel">Model:</label>
        <select id="leftModel">
          {% for m in models %}
            <option value="{{m.name}}">{{m.label}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="inline-field">
        <label for="tempL">Temperature:</label>
        <input type="number" id="tempL" value="0.7" step="0.1" min="0" max="1" />
      </div>

      <div class="inline-field">
        <label for="kL">Top K:</label>
        <input type="number" id="kL" value="40" />
      </div>

      <div class="inline-field">
        <label for="pL">Top P:</label>
        <input type="number" id="pL" value="0.9" step="0.1" min="0" max="1" />
      </div>
    </div>

    <div class="model-card">
      <h3>Right Model</h3>
      <div class="inline-field">
        <label for="rightModel">Model:</label>
        <select id="rightModel">
          {% for m in models %}
            <option value="{{m.name}}">{{m.label}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="inline-field">
        <label for="tempR">Temperature:</label>
        <input type="number" id="tempR" value="0.7" step="0.1" min="0" max="1" />
      </div>

      <div class="inline-field">
        <label for="kR">Top K:</label>
        <input type="number" id="kR" value="40" />
      </div>

      <div class="inline-field">
        <label for="pR">Top P:</label>
        <input type="number" id="pR" value="0.9" step="0.1" min="0" max="1" />
      </div>
    </div>
  </section>

  <section class="center-control">
    <button id="startBtn">Start Conversation</button>
  </section>

  <!-- Chat Area -->
  <main id="chatbox"></main>

  <!-- Bottom Controls -->
  <div class="bottom-bar">
    <button id="saveBtn" disabled>Save Conversation</button>
  </div>

  <!-- Footer -->
  <footer class="footer">ts @ 2025</footer>

  <!-- Conversation Init Modal -->
  <div id="initModal" class="modal">
    <div class="modal-content">
      <h2>ðŸŽ¯ Define the Left Model's Role & Goal</h2>
      <textarea id="userPrompt" placeholder="e.g., You are a philosopher exploring the ethics of AI consciousness..."></textarea>
      <div class="modal-actions">
        <button id="cancelInit">Cancel</button>
        <button id="confirmInit">Start</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // -------- Stopword list --------
    const STOP_WORDS = new Set([
      "a","an","the","and","or","but","if","then","so","as","at","by","for","from","in","into","of","on","to","up","with",
      "without","about","above","after","again","against","all","am","are","arenâ€™t","be","because","been","being","below",
      "between","both","can","could","did","do","does","doing","down","during","each","few","further","had","has","have",
      "having","he","her","here","hers","herself","him","himself","his","how","i","iâ€™m","iâ€™ve","iâ€™ll","iâ€™d","is","it","its",
      "itâ€™s","itself","let","me","more","most","my","myself","no","nor","not","now","off","once","only","other","our","ours",
      "ourselves","out","over","own","same","she","should","so","some","such","than","that","their","theirs","them",
      "themselves","then","there","these","they","this","those","through","too","under","until","very","was","we","were",
      "what","when","where","which","while","who","whom","why","will","with","would","you","your","yours","yourself","yourselves",
      "s", "t", "ve", "d", "m", "isn", "ll", "e", "g"
    ]);

    function topWords(text, n = 10) {
      const words = text.toLowerCase().replace(/[^a-z\s]/g, " ").split(/\s+/)
        .filter(w => w && !STOP_WORDS.has(w));
      const freq = {};
      for (const w of words) freq[w] = (freq[w] || 0) + 1;
      return Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, n);
    }

    let conversation = [];
    let currentRole = null;
    let currentBuffer = "";

    // -------- Modal Logic --------
    const modal = $("#initModal");
    const userPromptInput = $("#userPrompt");

    $("#startBtn").click(() => {
      modal.addClass("active");
      userPromptInput.val("").focus();
    });

    $("#cancelInit").click(() => {
      modal.removeClass("active");
    });

    $("#confirmInit").click(() => {
      const userPrompt = userPromptInput.val().trim();
      if (!userPrompt) {
        alert("Please define the Left Model's role or goal.");
        return;
      }
      modal.removeClass("active");
      startConversation(userPrompt);
    });

    // -------- Main Conversation Function --------
    async function startConversation(userPrompt) {
      const left = $("#leftModel").val();
      const right = $("#rightModel").val();
      const temperature = parseFloat($("#tempL").val());
      const top_k = parseInt($("#kL").val());
      const top_p = parseFloat($("#pL").val());

      $("#chatbox").html("<p class='system'>Starting conversation...</p>");
      $("#saveBtn").prop("disabled", true);
      conversation = [];

      const response = await fetch("/api/chat-stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ left_model: left, right_model: right, temperature, top_k, top_p, prompt: userPrompt }),
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      async function flushMessage(role) {
        if (!currentBuffer.trim()) return;
        const cssClass = role.includes(left)
          ? "left-msg"
          : role.includes(right)
          ? "right-msg"
          : "system";
        const modelLabel = `<strong class='model-name'>${role}</strong>`;
        const msgText = currentBuffer.trim();

        let freqHTML = "";
        if (cssClass !== "system") {
          const topFreq = topWords(msgText);
          if (topFreq.length) {
            freqHTML = `<div class='freq-box'><strong>Top Words:</strong> ${topFreq.map(([w, c]) => `<span>${w} (${c})</span>`).join(" ")}</div>`;
          }
        }

        conversation.push({ role, content: msgText });
        $("#chatbox").append(`<div class='${cssClass} fade-in'>${modelLabel}<div class='msg-text'>${msgText}</div>${freqHTML}</div>`);
        $("#chatbox").scrollTop($("#chatbox")[0].scrollHeight);
        currentBuffer = "";
      }

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split("\n\n");
        buffer = parts.pop();
        for (const part of parts) {
          if (!part.startsWith("data: ")) continue;
          const payload = JSON.parse(part.slice(6));
          const role = payload.role;
          const token = payload.token;
          if (role !== currentRole && currentRole !== null) await flushMessage(currentRole);
          currentRole = role;
          currentBuffer += token;
        }
      }

      await flushMessage(currentRole);
      $("#chatbox").append("<p class='system'>Conversation finished.</p>");
      $("#saveBtn").prop("disabled", false);
    }

    // -------- Save Conversation --------
    $("#saveBtn").click(async function () {
      if (!conversation.length) {
        showToast("âš ï¸ No conversation to save!");
        return;
      }

      const payload = {
        left_model: $("#leftModel").val(),
        right_model: $("#rightModel").val(),
        temperature: parseFloat($("#tempL").val()),
        top_k: parseInt($("#kL").val()),
        top_p: parseFloat($("#pL").val()),
        conversation,
      };

      try {
        const response = await fetch("/api/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (response.ok && result.status === "saved") {
          showToast(`âœ… Conversation saved! ID: ${result.id}`);
        } else {
          showToast(`âŒ Save failed: ${result.error || "Unknown error"}`);
        }
      } catch (err) {
        showToast(`âš ï¸ Save error: ${err.message}`);
      }
    });

    // -------- Toast Notification --------
    function showToast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      Object.assign(t.style, {
        position: "fixed",
        bottom: "80px",
        left: "50%",
        transform: "translateX(-50%)",
        background: "#a5b4fc",
        color: "#111827",
        padding: "10px 20px",
        borderRadius: "10px",
        fontWeight: "600",
        boxShadow: "0 2px 6px rgba(0,0,0,0.2)",
        opacity: 0,
        transition: "opacity 0.5s",
        zIndex: 9999
      });
      document.body.appendChild(t);
      setTimeout(() => (t.style.opacity = 1), 50);
      setTimeout(() => {
        t.style.opacity = 0;
        setTimeout(() => t.remove(), 500);
      }, 3000);
    }

    // -------- Go Top Button --------
    const goTopBtn = document.getElementById("goTopBtn");
    const chatbox = document.getElementById("chatbox");

    chatbox.addEventListener("scroll", () => {
      goTopBtn.classList.toggle("show", chatbox.scrollTop > 200);
    });
    goTopBtn.addEventListener("click", () => {
      chatbox.scrollTo({ top: 0, behavior: "smooth" });
    });
  </script>

  <button id="goTopBtn" title="Go to top">â¬†</button>
</body>
</html>
